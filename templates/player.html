<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="mobile dark">
  <header class="topbar">
    <button class="back-btn" onclick="location.href='{{ url_for('home') }}'">←</button>
    <div class="title">Now Playing</div>
    <div class="top-actions">⋮</div>
  </header>

  <main class="player-screen">
    <div class="album-wrap">
      <img id="player-thumb" class="album-large" src="{{ thumb }}" alt="Album">
    </div>

    <div class="track-info">
      <div class="track-title" id="title">{{ title }}</div>
      <div class="track-artist" id="artist">{{ artist }}</div>
    </div>

    <div class="progress">
      <span id="current">0:00</span>
      <input id="seek" type="range" min="0" max="100" value="0" />
      <span id="total">0:00</span>
    </div>

    <div class="controls">
      <button class="ctrl">⏮</button>
      <button id="playBtn" class="play-prim" onclick="togglePlay()">⏵</button>
      <button class="ctrl">⏭</button>
    </div>

    <!-- small volume bar under the current song (persisted) -->
    <div class="volume-control" style="margin-top:10px;display:flex;align-items:center;gap:8px;">
      <div style="font-size:14px;color:var(--muted)">Vol</div>
      <input type="range" id="volume" min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)">
    </div>

    <div class="bottom-actions">
      <button id="favBtn" class="circle" onclick="toggleFav()">♡</button>
      <div class="spacer"></div>
      <button class="circle">↻</button>
    </div>

    <audio id="audio" preload="auto" src="{{ audio_url }}"></audio>
  </main>

  <nav class="bottom-nav elevated">
    <a class="nav-item" href="{{ url_for('home') }}">🏠</a>
    <a class="nav-item" href="{{ url_for('search') }}">🔍</a>
    <a class="nav-item active" href="{{ url_for('profile') }}">👤</a>
  </nav>

  <script>
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const favBtn = document.getElementById('favBtn');

    // initial metadata from server-rendered template
    const initial = {
      audioUrl: "{{ audio_url }}",
      title: "{{ title }}",
      thumb: "{{ thumb }}",
      cookie: "{{ cookie }}",
      auto_play: "{{ auto_play }}"
    };

    // initialize volume from localStorage if present
    const savedVol = localStorage.getItem('player_volume');
    if (savedVol !== null) {
      audio.volume = parseFloat(savedVol);
      document.getElementById('volume').value = audio.volume;
    } else {
      // default volume is 1.0
      audio.volume = 1.0;
    }

    function togglePlay() {
      if (audio.paused) {
        audio.play().then(() => {
          playBtn.textContent = '⏸';
        }).catch(()=> {
          // could not autoplay due to browser policy
          playBtn.textContent = '⏵';
        });
      } else {
        audio.pause();
        playBtn.textContent = '⏵';
      }
    }

    function setVolume(value) {
      audio.volume = parseFloat(value);
      localStorage.setItem('player_volume', audio.volume);
    }

    // small progress updater
    audio.addEventListener('timeupdate', () => {
      const cur = Math.floor(audio.currentTime);
      const total = Math.floor(audio.duration || 0);
      function fmt(s){ return Math.floor(s/60)+':' + String(s%60).padStart(2,'0'); }
      document.getElementById('current').textContent = fmt(cur);
      document.getElementById('total').textContent = fmt(total);
      const seek = document.getElementById('seek');
      if (total > 0) seek.value = Math.floor((audio.currentTime / audio.duration) * 100);
    });

    document.getElementById('seek').addEventListener('input', function(){
      if (!audio.duration) return;
      audio.currentTime = (this.value / 100) * audio.duration;
    });

    // toggleFav is provided in static/script.js; keep that behaviour
    // Auto-play if auto_play passed
    if (initial.auto_play) {
      audio.play().then(()=> { playBtn.textContent='⏸'; }).catch(()=>{});
    }
  </script>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
