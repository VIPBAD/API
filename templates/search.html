<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="mobile dark">
  <header class="topbar">
    <button class="back-btn" onclick="location.href='{{ url_for('home') }}'">←</button>
    <div class="title">Search</div>
    <div class="top-actions">⋮</div>
  </header>

  <main class="list-screen">
    <form class="search-box" action="{{ url_for('search') }}" method="get">
      <input type="search" name="q" placeholder="Search songs, artists..." value="{{ q }}" />
      <button type="submit">🔎</button>
    </form>

    <section class="results">
      {% for r in results %}
      <div class="result-row">
        <a class="result-item" href="{{ url_for('player') }}?audio={{ r.audio|urlencode }}&title={{ r.title|urlencode }}&thumb={{ r.thumb|urlencode }}">
          <img src="{{ r.thumb }}" alt="" />
          <div class="r-info">
            <div class="r-title">{{ r.title }}</div>
            <div class="r-sub">{{ r.artist }}</div>
          </div>
        </a>
        <!-- Play with cookie: picks a cookie on server and then opens player with cookie param -->
        <div class="r-actions">
          <button onclick="playWithCookie('{{ r.audio }}','{{ r.title|replace(\"'\",\"\\'\") }}','{{ r.thumb }}','{{ r.artist }}')">Play</button>
          <button onclick="addFavoriteFromSearch(event,'{{ r.title }}','{{ r.artist }}','{{ r.audio }}','{{ r.thumb }}')">♡</button>
        </div>
      </div>
      {% endfor %}
    </section>
  </main>

  <nav class="bottom-nav">
    <a class="nav-item" href="{{ url_for('home') }}">🏠</a>
    <a class="nav-item active" href="{{ url_for('search') }}">🔍</a>
    <a class="nav-item" href="{{ url_for('profile') }}">👤</a>
  </nav>

  <script>
    async function playWithCookie(audio, title, thumb, artist){
      try {
        const res = await fetch('/pick_cookie');
        const data = await res.json();
        if (!data.ok) {
          alert('Could not pick cookie: ' + (data.error || 'unknown'));
          return;
        }
        const cookie = encodeURIComponent(data.cookie || '');
        // go to player with cookie param (server or youtube helper may use it)
        const params = new URLSearchParams({
          audio: audio,
          title: title,
          thumb: thumb,
          artist: artist,
          cookie: cookie
        });
        // player will save username if provided via session or query params
        location.href = '/player?' + params.toString();
      } catch (e) {
        alert('Error picking cookie: ' + e);
      }
    }

    // existing addFavoriteFromSearch is provided by static/script.js in repo, we reuse it
  </script>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
  </html>
